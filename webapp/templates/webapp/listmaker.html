{% extends "webapp/base.html" %}

{% block title %}ListMaker Dashboard{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="text-center">ListMaker Dashboard</h1>

    <!-- Form for Adding Items -->
    <div class="card mb-4">
        <div class="card-header">Add New Item</div>
        <div class="card-body">
            <form id="add-item-form">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="name" class="form-label">Title:</label>
                    <input type="text" id="name" name="name" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description:</label>
                    <textarea id="description" name="description" class="form-control" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Item</button>
            </form>            
        </div>
    </div>

    <!-- DataTable for Viewing the List -->
    <div class="card">
        <div class="card-header">List of Items</div>
        <div class="card-body">
            <table id="listTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Votes Needed</th>
                        <th>Votes Had</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be dynamically populated -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        function fetchItems() {
            fetch("/items/")
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector("#listTable tbody");
                    tbody.innerHTML = "";
                    data.forEach(item => {
                        const row = `
                        <tr>
                            <td>${item.number_in_list}</td>
                            <td>${item.name}</td>
                            <td>${item.description}</td>
                            <td>${item.is_valid === true ? "Valid" : item.is_valid === false ? "Not Valid" : "Pending"}</td>
                            <td>${item.votes_needed}</td>
                            <td>${item.votes_had}</td>
                            <td>
                                <button class="btn btn-warning btn-sm">Edit</button>
                            </td>
                        </tr>`;
                        tbody.insertAdjacentHTML("beforeend", row);
                    });
                })
                .catch(error => console.error("Error fetching items:", error));
        }

        fetchItems();

        document.getElementById("add-item-form").addEventListener("submit", function (e) {
            e.preventDefault(); // Prevent page reload

            const name = document.getElementById("name").value.trim();
            const description = document.getElementById("description").value.trim();

            console.log("Form data:", { name, description }); // Log the form data

            if (!name || !description) {
                alert("Both Title and Description are required.");
                return;
            }

            fetch("/add-item/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    votes_needed: 1,
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Item added successfully!");
                        document.getElementById("add-item-form").reset();
                        fetchItems(); // Refresh the table
                    } else {
                        alert("Error: " + data.error);
                    }
                })
                .catch(error => console.error("Error adding item:", error));
        });

    });
</script>
{% endblock %}