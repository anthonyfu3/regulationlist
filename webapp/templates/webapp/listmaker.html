{% extends "webapp/base.html" %}

{% block title %}ListMaker Dashboard{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="text-center">ListMaker Dashboard</h1>

    <!-- Form for Adding Items -->
    <div class="card mb-4">
        <div class="card-header">Add New Item</div>
        <div class="card-body">
            <form id="addItemForm">
                <div class="mb-3">
                    <label for="itemTitle" class="form-label">Title</label>
                    <input type="text" class="form-control" id="itemTitle" placeholder="Enter title" required>
                </div>
                <div class="mb-3">
                    <label for="itemDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="itemDescription" rows="3" placeholder="Enter description"
                        required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Item</button>
            </form>
        </div>
    </div>

    <!-- DataTable for Viewing the List -->
    <div class="card">
        <div class="card-header">List of Items</div>
        <div class="card-body">
            <table id="listTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Votes Needed</th>
                        <th>Votes Had</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be dynamically populated -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const table = new DataTable("#listTable", {
            paging: true,
            searching: true,
            ordering: true,
        });

        // Fetch and populate the DataTable
        function fetchItems() {
            fetch("/items/")
                .then((response) => response.json())
                .then((data) => {
                    const tbody = document.querySelector("#listTable tbody");
                    tbody.innerHTML = "";
                    data.forEach((item) => {
                        const row = `
            <tr>
              <td>${item.number_in_list}</td>
              <td>${item.name}</td>
              <td>${item.description}</td>
              <td>${item.is_valid === true ? "Valid" : item.is_valid === false ? "Not Valid" : "Pending"}</td>
              <td>${item.votes_needed}</td>
              <td>${item.votes_had}</td>
              <td>
                <button class="btn btn-sm btn-warning edit-btn" data-id="${item.number_in_list}">Edit</button>
              </td>
            </tr>`;
                        tbody.insertAdjacentHTML("beforeend", row);
                    });
                })
                .catch((error) => console.error("Error fetching items:", error));
        }

        fetchItems();

        // Handle form submission
        document.getElementById("addItemForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const title = document.getElementById("itemTitle").value;
            const description = document.getElementById("itemDescription").value;

            fetch("/items/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    name: title,
                    description: description,
                    votes_needed: 1,
                }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        fetchItems(); // Refresh the table
                        document.getElementById("addItemForm").reset();
                    } else {
                        alert("Error adding item: " + data.error);
                    }
                })
                .catch((error) => console.error("Error adding item:", error));
        });
    });
</script>
{% endblock %}